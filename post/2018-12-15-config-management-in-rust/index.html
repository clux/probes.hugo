<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Config management in rust - probes</title>
<meta name=description content="Building a secure yaml api for kubernetes">
<meta name=author content="clux"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"probes","url":"https:\/\/clux.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/clux.dev\/"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/clux.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/clux.dev\/post\/2018-12-15-config-management-in-rust\/","name":"Config management in rust"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"clux"},"headline":"Config management in rust","description":"At babylon health we have a ton of microservices running on kubernetes that are, in turn, controlled by hundreds of thousands of lines of autogenerated yaml.\nSo for our own sanity, we built shipcat - a standardisation tool (powered by rust-lang and serde) to control the declarative format and lifecycle of every microservice.\n","inLanguage":"en","wordCount":1704,"datePublished":"2018-12-15T00:00:00","dateModified":"2018-12-15T00:00:00","image":"https:\/\/clux.dev\/","keywords":["shipcat, rust, kubernetes"],"mainEntityOfPage":"https:\/\/clux.dev\/post\/2018-12-15-config-management-in-rust\/","publisher":{"@type":"Organization","name":"https:\/\/clux.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/clux.dev\/","height":60,"width":60}}}</script>
<meta property="og:title" content="Config management in rust">
<meta property="og:description" content="Building a secure yaml api for kubernetes">
<meta property="og:url" content="https://clux.dev/post/2018-12-15-config-management-in-rust/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="probes">
<meta name=twitter:title content="Config management in rust">
<meta name=twitter:description content="Building a secure yaml api for kubernetes">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@sszynrae">
<meta name=twitter:creator content="@sszynrae">
<meta name=generator content="Hugo 0.87.0">
<link rel=alternate href=https://clux.dev/index.xml type=application/rss+xml title=probes><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://clux.dev/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://clux.dev/css/syntax.css><link rel=stylesheet href=https://clux.dev/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://clux.dev/>probes</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
<li>
<a title=Blog href=https://clux.dev/>Blog</a>
</li>
<li>
<a title=About href=https://clux.dev/page/about/>About</a>
</li>
<li>
<a title=Tags href=https://clux.dev/tags>Tags</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<h1>Config management in rust</h1>
<h2 class=post-subheading>Building a secure yaml api for kubernetes</h2>
<span class=post-meta>
<i class="fas fa-calendar"></i>&nbsp;Posted on December 15, 2018
&nbsp;(Last modified on December 16, 2018)
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;clux
</span>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<p>At <a href=https://www.babylonhealth.com/>babylon health</a> we have a ton of microservices running on kubernetes that are, in turn, controlled by <strong>hundreds of thousands of lines</strong> of autogenerated <code>yaml</code>.</p>
<p>So for our own sanity, we built <a href=https://github.com/Babylonpartners/shipcat><code>shipcat</code></a> - a standardisation tool (powered by <a href=https://www.rust-lang.org/>rust-lang</a> and <a href=https://serde.rs/>serde</a>) to control the declarative format and lifecycle of every microservice.</p>
<p>..but first, a bit about the problem:</p>
<h2 id=kubernetes-api>Kubernetes API</h2>
<p>Deploying services to kubernetes is no easy task. The abstraction might be <em>nice</em> once you&rsquo;ve wrapped your head around it, but it&rsquo;s a significant mental overhead for hundreds of engineers to have to understand. Try telling every engineer that they all need to hand craft their <code>yaml</code> for whatever they need of:</p>
<ul>
<li><code>ConfigMap</code></li>
<li><code>Secrets</code></li>
<li><code>Deployment</code> / <code>ReplicaSet</code> / <code>Pod</code></li>
<li><code>Service</code></li>
<li><code>HorizontalPodAutoscaler</code></li>
<li><code>ServiceAccount</code></li>
<li><code>Role</code></li>
<li><code>RoleBinding</code></li>
<li><code>Ingress</code></li>
</ul>
<p>and you&rsquo;ll quickly realize that this does not scale. Your engineers maybe be able to handle it, but they shouldn&rsquo;t all have to deal with this excessively verbose API which lacks in crucial validation. Instead, creating a standard gives your platform internal consistency and makes it easier to upgrade manage.</p>
<h2 id=helm>Helm</h2>
<p>One of the main abstraction attempts kubernetes has seen in this space is <code>helm</code>. A client side templating system (ignoring the bad server side part) that lets you abstract away much of the above into <code>charts</code> (a collection of <code>yaml</code> go templates) ready to be filled in with <code>helm values</code>; the more concise <code>yaml</code> that developers write directly.</p>
<p>Simplistic usage of <code>helm</code> would involve having a <code>charts</code> folder:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>charts
└── base
    ├── Chart.yaml
    ├── templates
    │   ├── configmap.yamls
    │   ├── deployment.yaml
    │   ├── hpa.yaml
    │   ├── rbac.yaml
    │   ├── secrets.yaml
    │   ├── serviceaccount.yaml
    │   └── service.yaml
    └── values.yaml
</code></pre></div><p>and calling it with your substitute <code>myvalues.yaml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>helm template charts/base myapp -f myvalues.yaml | <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>    kubectl apply -lapp<span style=color:#ff79c6>=</span>myapp --prune -f -
</code></pre></div><p>which will garbage collect older kube resources with the <code>myapp</code> label, and start any necessary rolling upgrades in kubernetes.</p>
<h3 id=drawbacks>Drawbacks</h3>
<p>Even though you can avoid a lot of the common errors by re-using charts across apps, there&rsquo;s still very little sanity on what helm values can contain. Here are some values you can pass through a helm chart to kube and still be accepted:</p>
<ul>
<li>misspelled optional values (silently ignored)</li>
<li>resource requests exceeding largest node (cannot schedule nor vertically auto scale)</li>
<li>resource requests > resource limits (illogical)</li>
<li>out of date secrets (generally causing crashes)</li>
<li>missing health checks / <code>readinessProbe</code> (broken services can rollout)</li>
<li>images and versions that does not exist (fails to install/upgrade)</li>
</ul>
<p>And that&rsquo;s once you&rsquo;ve gotten over how frurstrating it can be to write helm templates in the first place.</p>
<h2 id=limitations>Limitations</h2>
<p>While validation is a fixable annoyance, a bigger observation is that these helm values files become a really interesting, but entirely <strong>accidental abstraction</strong>. These files become the canonical representation of your services, but you have no useful logic around it. You have very little validation, almost no definition of what&rsquo;s allowed in there (<code>helm lint</code> is lackluster), you have no process of standardisation, it&rsquo;s hard to test sprawling automation scripts around the values files, and you do not have any sane way of evolving these charts.</p>
<h2 id=main-idea-shipcathttpsgithubcombabylonpartnersshipcat>Main idea: <a href=https://github.com/Babylonpartners/shipcat><code>shipcat</code></a></h2>
<p>What if if we could take the general idea that developers just write simplified <em>yaml manifests</em> for their app, but we actually define that API instead? By actually defining the structs we can provide a bunch of security checking and validation on top of it, and we will have a well-defined boundary for automation / ci / dev tools.</p>
<p>By defining all our syntax in a library we can have cli tools for automation and executables running as kube operators using the same definitions. It effectively provides a way for us to versioning our platform.</p>
<p>It also allows us to solve the secret problem. We can extend the manifests with syntax that allows synchronsing secrets from <a href=https://www.hashicorp.com/products/vault/>Vault</a> at both deploy and validation time.</p>
<h2 id=disclaimer>Disclaimer</h2>
<p>This style of tool is not a revolutionary idea. Last kubecon pretty much everyone had their own wrappers around <code>yaml</code> to help with these problems. Some common examples these days are: <code>kubecfg</code>, <code>ksonnet</code>, <code>flux</code>, <code>helmfile</code>, which all try to help out in this space, but they were all missing most of the sanity we required when we started experimenting at the start of 2018.</p>
<p>Note that this was our first take on adding some validation around kube in a world that had a lot of external config management that didn&rsquo;t plug nicely into kube. It&rsquo;s heavily evolving and not general purpose as it stands. Extra parts of our validation will probably still move to a more declarative format (like <a href=https://www.openpolicyagent.org/>OPAs</a>) than the raw logic described herein.</p>
<h2 id=manifests>Manifests</h2>
<p>When migrating to kubernetes, the abstraction we settled on was service-level manifests:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>name</span>: webapp
<span style=color:#ff79c6>image</span>: clux/webapp-rs
<span style=color:#ff79c6>version</span>: <span style=color:#bd93f9>0.2.0</span>
<span style=color:#ff79c6>env</span>:
  <span style=color:#ff79c6>DATABASE_URL</span>: IN_VAULT
<span style=color:#ff79c6>resources</span>:
  <span style=color:#ff79c6>requests</span>:
    <span style=color:#ff79c6>cpu</span>: 100m
    <span style=color:#ff79c6>memory</span>: 100Mi
  <span style=color:#ff79c6>limits</span>:
    <span style=color:#ff79c6>cpu</span>: 300m
    <span style=color:#ff79c6>memory</span>: 300Mi
<span style=color:#ff79c6>replicaCount</span>: <span style=color:#bd93f9>2</span>
<span style=color:#ff79c6>health</span>:
  <span style=color:#ff79c6>uri</span>: /health
<span style=color:#ff79c6>httpPort</span>: <span style=color:#bd93f9>8000</span>
<span style=color:#ff79c6>regions</span>:
- minikube
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>contacts</span>:
  - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;Eirik&#34;</span>
    <span style=color:#ff79c6>slack</span>: <span style=color:#f1fa8c>&#34;@clux&#34;</span>
  <span style=color:#ff79c6>team</span>: Doves
  <span style=color:#ff79c6>repo</span>: https://github.com/clux/webapp-rs
</code></pre></div><p>This encapsulates the most important kube apis that developers should configure themselves, who&rsquo;s responsible for it, what regions it&rsquo;s deployed in, what secrets are needed (notice the <code>IN_VAULT</code> marker), and how resource intensive it is.</p>
<h2 id=strict-syntax>Strict Syntax</h2>
<p>Because these manifests were going to be the entry point for CI pipelines and handle platform specific validation (for medical software), we wanted maximum strictness everywhere and that includes the ability to catch errors before manifests are committed to <code>master</code>.</p>
<p>We lean heavily on <a href=https://serde.rs/attributes.html>serde&rsquo;s customisable codegeneration</a> to easily encapsulate even the most awkward kube apis - that we want our developers to take advantage of - and to auto-generate the boilerplate validation around types and spelling errors.</p>
<p>Here&rsquo;s our structs that encapsulate <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Role-based access control</a> for applications consuming kube apis:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#ff79c6>#[derive(Serialize, Deserialize, Clone, Debug)]</span>
<span style=color:#ff79c6>#[serde(deny_unknown_fields)]</span>
<span style=color:#ff79c6>pub</span> <span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>Rbac</span> {
    <span style=color:#f1fa8c>/// API groups containing resources (defined below)
</span><span style=color:#f1fa8c></span>    <span style=color:#ff79c6>pub</span> apiGroups: <span style=color:#8be9fd;font-style:italic>Vec</span><span style=color:#ff79c6>&lt;</span>AllowedApiGroups<span style=color:#ff79c6>&gt;</span>,
    <span style=color:#f1fa8c>/// Resources on which to apply verbs / actions
</span><span style=color:#f1fa8c></span>    <span style=color:#ff79c6>pub</span> resources: <span style=color:#8be9fd;font-style:italic>Vec</span><span style=color:#ff79c6>&lt;</span>AllowedResources<span style=color:#ff79c6>&gt;</span>,
    <span style=color:#f1fa8c>/// Actions to be allowed
</span><span style=color:#f1fa8c></span>    <span style=color:#ff79c6>pub</span> verbs: <span style=color:#8be9fd;font-style:italic>Vec</span><span style=color:#ff79c6>&lt;</span>AllowedVerbs<span style=color:#ff79c6>&gt;</span>
}

<span style=color:#ff79c6>#[derive(Serialize, Deserialize, Clone, Debug)]</span>
<span style=color:#ff79c6>#[serde(rename_all = </span><span style=color:#f1fa8c>&#34;lowercase&#34;</span><span style=color:#ff79c6>)]</span>
<span style=color:#ff79c6>pub</span> <span style=color:#ff79c6>enum</span> <span style=color:#50fa7b>AllowedApiGroups</span> {
    <span style=color:#ff79c6>#[serde(rename = </span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)]</span>
    Empty,
    Extensions,
    Batch,
    <span style=color:#ff79c6>#[serde(rename = </span><span style=color:#f1fa8c>&#34;babylontech.co.uk&#34;</span><span style=color:#ff79c6>)]</span>
    Babylontech,
}

<span style=color:#ff79c6>#[derive(Serialize, Deserialize, Clone, Debug)]</span>
<span style=color:#ff79c6>#[serde(rename_all = </span><span style=color:#f1fa8c>&#34;lowercase&#34;</span><span style=color:#ff79c6>)]</span>
<span style=color:#ff79c6>pub</span> <span style=color:#ff79c6>enum</span> <span style=color:#50fa7b>AllowedResources</span> {
    Deployments,
    ReplicaSets,
    Jobs,
    CronJobs,
    Pods,
    <span style=color:#ff79c6>#[serde(rename = </span><span style=color:#f1fa8c>&#34;pods/log&#34;</span><span style=color:#ff79c6>)]</span>
    PodsSlashLog,
    ConfigMaps,
    Namespaces,
    HorizontalPodAutoscaler,
    Events,
    Nodes,
    RoleBindings,
    Roles,
    Secrets,
    ServiceAccounts,
    Services,
    ShipcatManifests,
    ShipcatConfigs,
}

<span style=color:#ff79c6>#[derive(Serialize, Deserialize, Clone, Debug)]</span>
<span style=color:#ff79c6>#[serde(rename_all = </span><span style=color:#f1fa8c>&#34;lowercase&#34;</span><span style=color:#ff79c6>)]</span>
<span style=color:#ff79c6>pub</span> <span style=color:#ff79c6>enum</span> <span style=color:#50fa7b>AllowedVerbs</span> {
    List,
    Get,
    Watch,
}
</code></pre></div><p>Notice the awkward empty string having explicit meanings in the kube api, which <code>serde</code> elegantly normalises with a <code>rename</code> field level attribute, but obeying the <code>rename_all</code> container level attribute as an overrideable default.</p>
<p>In other words, <code>serde</code> takes care of most of our validation. It even catches spelling-errors and extraneous types/keys due to the <code>#[serde(deny_unknown_fields)]</code> instruction.</p>
<p>While this goes way beyond what you normally can do with a yaml validator: we can still do better. Every struct can implement a <code>verify</code> function that encapsulates common mistakes that are clearly errors and should be caught before they are sent out to our kube clusters:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#ff79c6>impl</span> Rbac {
    <span style=color:#ff79c6>pub</span> <span style=color:#ff79c6>fn</span> <span style=color:#50fa7b>verify</span>(<span style=color:#ff79c6>&amp;</span>self) -&gt; <span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#ff79c6>&lt;</span>()<span style=color:#ff79c6>&gt;</span> {
        <span style=color:#ff79c6>if</span> self.apiGroups.is_empty() {
            bail<span style=color:#ff79c6>!</span>(<span style=color:#f1fa8c>&#34;RBAC needs to have at least one item in apiGroups&#34;</span>);
        }
        <span style=color:#ff79c6>if</span> self.resources.is_empty() {
            bail<span style=color:#ff79c6>!</span>(<span style=color:#f1fa8c>&#34;RBAC needs to have at least one item in resources&#34;</span>);
        }
        <span style=color:#ff79c6>if</span> self.verbs.is_empty() {
            bail<span style=color:#ff79c6>!</span>(<span style=color:#f1fa8c>&#34;RBAC needs to have at least one item in verbs&#34;</span>);
        }
        <span style=color:#8be9fd;font-style:italic>Ok</span>(())
    }
}
</code></pre></div><p>We don&rsquo;t trait these functions because we sometimes pass around some context from other structures to have cross-referencing validation.</p>
<p>Finally, this <code>Rbac</code> struct is attached to our core <a href=https://babylonpartners.github.io/shipcat/shipcat_definitions/manifest/struct.Manifest.html>Manifest</a> so developers can take advantage of it by simply adding:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>rbac</span>:
- <span style=color:#ff79c6>apiGroups</span>: [<span style=color:#f1fa8c>&#34;extensions&#34;</span>]
  <span style=color:#ff79c6>resources</span>: [<span style=color:#f1fa8c>&#34;deployments&#34;</span>]
  <span style=color:#ff79c6>verbs</span>: [<span style=color:#f1fa8c>&#34;get&#34;</span>, <span style=color:#f1fa8c>&#34;watch&#34;</span>, <span style=color:#f1fa8c>&#34;list&#34;</span>]
</code></pre></div><p>to their service manifest. That&rsquo;s it. They now have a service that is allowed can watch kube <code>Deployment</code> objects via a generated in-cluster service account token.</p>
<p>In this case, this syntax is a straight translation of the kubernetes API (but leaving out the boilerplate static yaml), and this is often what we do in <code>shipcat</code>.</p>
<p>In some cases, however, we do provide our own simplifying abstractions, but this tends to be for other integrations.</p>
<p>All of our syntax is defined in <a href=https://github.com/Babylonpartners/shipcat/blob/master/shipcat_definitions/src/structs/>shipcat/structs</a> so that our developers can easily extend the syntax once we&rsquo;ve reached code-review consensus.</p>
<p>Once a new version of <code>shipcat</code> is released, we bump its pin in our <a href=https://github.com/Babylonpartners/shipcat/blob/master/examples>configuration repository with all our manifests</a>, and the new syntax + feature becomes availble to developers.</p>
<h2 id=developer--pre-merge-ci-usage>Developer / Pre-merge CI Usage</h2>
<p>Developers can check that their manifests pass validation rules locally, or wait for pre-merge validation on CI:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>shipcat validate myapp
</code></pre></div><p>which will run all the associated rules required by the manifest for this service.</p>
<p>To further check what kube yaml this is generating we have:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>shipcat template myapp
</code></pre></div><p>which is roughly equivalent to:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>shipcat values myapp | helm template charts/base
</code></pre></div><p>We do currently lean on helm charts for generating the complete kube yaml, but this is an implementation detail that only a handful of engineers need to touch as we follow the <a href="https://www.youtube.com/watch?v=HzJ9ycX1h0c">one chart to rule them all approach</a>. Charts are also linted with <a href=https://github.com/garethr/kubeva><code>kubeval</code></a> against all services in all regions during chart upgrades.</p>
<h2 id=upgrade-ci-usage>Upgrade CI Usage</h2>
<p>We currently provide a wrapper around the entire <code>upgrade</code> process with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>shipcat apply myapp
</code></pre></div><p>and a CI reconciliation wrapper:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>shipcat cluster helm reconcile
</code></pre></div><p>which will wait for the helm release(s) (working around various tiller bugs to do so correctly).</p>
<p>This is an abstraction that is due for a change, however. The <a href=https://github.com/Babylonpartners/shipcat/issues/11>tiller dependency is being removed on our end</a>, and meanwhile, <a href=https://github.com/helm/community/blob/master/helm-v3/000-helm-v3.md>helm 3 is rearchitecting away tiller entirely</a>.</p>
<h2 id=conclusion>Conclusion</h2>
<p>The ability to standardise, version, manage secrets, gradually introduce features to our kube clusters, and have a common point to write automation on top of has been invaluable to us. Huge thanks to <a href=https://www.rust-lang.org/>rust</a> and <a href=https://serde.rs/>serde</a> for making it this easy to do. &lt;3</p>
<h2 id=going-further>Going further</h2>
<p>While the core part of shipcat is the <a href=https://babylonpartners.github.io/shipcat/shipcat_definitions>standardised syntax</a>, we also have a bunch of automation/integrations in the <a href=https://github.com/Babylonpartners/shipcat/blob/master/shipcat_cli>shipcat cli</a>, as well as a kubernetes operator; <a href=https://github.com/Babylonpartners/shipcat/blob/master/raftcat>raftcat</a> (where we really see code-generation and generics shine). We&rsquo;ll talk about these further another time.</p>
<p>In the mean time, feel free to dig around; <a href=https://github.com/Babylonpartners/shipcat>shipcat is open source</a>. There&rsquo;s also our talk: <a href="https://www.youtube.com/watch?v=FvKQP7Qnfuc">Babylon Health - Leveraging Kubernetes for global scale</a> from DoxLon2018 for a little more context.</p>
<div class=blog-tags>
<a href=https://clux.dev//tags/shipcat/>shipcat</a>&nbsp;
<a href=https://clux.dev//tags/rust/>rust</a>&nbsp;
<a href=https://clux.dev//tags/kubernetes/>kubernetes</a>&nbsp;
</div>
<h4 class=see-also>See also</h4>
<ul>
<li><a href=https://clux.dev/post/2021-02-28-kube-evolution/>Evolution of kube</a></li>
<li><a href=https://clux.dev/post/2019-06-04-towards-a-generic-kube-client/>A generic kubernetes client</a></li>
<li><a href=https://clux.dev/post/2019-04-29-rust-on-kubernetes/>Kubernetes operators in rust</a></li>
<li><a href=https://clux.dev/post/2019-03-31-impersonating-kube-accounts/>Impersonating kube service accounts</a></li>
</ul>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://clux.dev/post/2013-03-20-colemak-switchover/ data-toggle=tooltip data-placement=top title="Colemak Switchover">&larr; Previous Post</a>
</li>
<li class=next>
<a href=https://clux.dev/post/2019-01-17-three-way-charm/ data-toggle=tooltip data-placement=top title="Three Way Charms">Next Post &rarr;</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
<li>
<a href=mailto:sszynrae@gmail.com title="Email me">
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://github.com/clux title=GitHub>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://twitter.com/sszynrae title=Twitter>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://reddit.com/u/clux title=Reddit>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-reddit-alien fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://linkedin.com/in/%f0%9f%97%91-eirik-albrigtsen-b279863a title=LinkedIn>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://www.youtube.com/channel/UCLpykMxkxuPUR9CciheipZg title=Youtube>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://www.strava.com/athletes/49770219 title=strava>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-strava fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="credits copyright text-muted">
clux
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://clux.dev/>probes</a>
</p>
<p class="credits theme-by text-muted">
<a href=https://gohugo.io>Hugo v0.87.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=0fc18328693fe9fe2c605484f516d65ea5cff649>0fc18328</a>]
</p>
</div>
</div>
</div>
</footer><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://clux.dev/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://clux.dev/js/load-photoswipe.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})</script>
</body>
</html>